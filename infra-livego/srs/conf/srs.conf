listen              1935;
max_connections     1000;
daemon              off;
srs_log_tank        console;

# Configuração da API HTTP
http_api {
    enabled         on;
    listen          1985;
    crossdomain     on;
}

# Servidor HTTP para HLS e outros
http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
}

# Configuração do servidor RTC para WebRTC
rtc_server {
    enabled         on;
    listen          8000;  # Porta UDP para WebRTC
    
    # O candidato deve ser o IP público ou acessível da sua rede
    candidate       72.60.249.175;  # Substitua pelo seu IP público se for acessar externamente
    
    # Se estiver rodando localmente, adicione também o IP local
    candidate       192.168.3.12;  # Seu IP local na rede
    
    # Se estiver usando Docker, adicione o IP do contêiner
    candidate       172.20.16.1;  # IP da interface de rede do Docker
}

vhost __defaultVhost__ {
    # Configuração RTC
    rtc {
        enabled             on;
        rtmp_to_rtc         on;
        rtc_to_rtmp         on;
        nack                on;
        twcc                on;
        # Tamanho do buffer para controle de congestionamento
        pli_for_rtmp        on;
        # Tempo máximo de buffer (em ms)
        min_latency         on;
        play {
            # Configuração de latência baixa para streaming ao vivo
            mix_correct     on;
            # Tamanho do buffer de reprodução (em ms)
            rw_timeout      10s;
        }
    }
    
    # Hooks HTTP
    http_hooks {
        enabled         on;
        # Ajuste para o endereço da sua API
        on_connect     http://host.docker.internal:3000/api/srs/connect;
        on_close       http://host.docker.internal:3000/api/srs/close;
        on_publish     http://host.docker.internal:3000/api/srs/publish;
        on_unpublish   http://host.docker.internal:3000/api/srs/unpublish;
        on_play        http://host.docker.internal:3000/api/srs/play;
        on_stop        http://host.docker.internal:3000/api/srs/stop;
        on_dvr         http://host.docker.internal:3000/api/srs/dvr;
        on_hls         http://host.docker.internal:3000/api/srs/hls;
        on_hls_notify  http://host.docker.internal:3000/api/srs/hls/notify;
    }
    
    # Configuração de DVR (gravação)
    dvr {
        enabled         on;
        dvr_path       ./objs/nginx/html/dvr/[app]/[stream]/[timestamp].flv;
        dvr_plan       session;
        dvr_duration   30s;
        dvr_wait_keyframe on;
    }
    
    # Configuração HLS
    hls {
        enabled         on;
        hls_fragment    1;
        hls_window      6;
        hls_path        ./objs/nginx/html/hls;
        hls_m3u8_file   [app]/[stream].m3u8;
        hls_ts_file     [app]/[stream]-[seq].ts;
    }
}
